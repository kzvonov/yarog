<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–õ–∏—Å—Ç –≥–µ—Ä–æ—è ‚Äî Dungeon World</title>

  <link rel="icon" href="/icon.png" type="image/png">
  <link rel="icon" href="/icon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="/icon.png">

  <style>
    /* Hero-specific styles (not in ui.css) */

    .header .class-name {
      font-size: 0.95rem;
      color: var(--accent-blood-light);
      letter-spacing: 0.3em;
      margin-top: 5px;
    }

    /* Connection indicator */
    .connection-indicator {
      position: absolute;
      top: 15px;
      right: 20px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .connection-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent-green);
    }

    .connection-dot.offline {
      background: var(--accent-blood);
    }

    .connection-dot.syncing {
      background: var(--accent-gold);
      animation: pulse 1s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    /* Settings panel */
    .settings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .settings-field label {
      display: block;
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .settings-field input,
    .settings-field select {
      width: 100%;
      padding: 8px 10px;
      background: var(--input-bg);
      border: 1px solid var(--border-dark);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.9rem;
    }

    .settings-field input:focus,
    .settings-field select:focus {
      outline: none;
      border-color: var(--accent-blood);
    }

    .panel-actions {
      margin-top: 15px;
      display: flex;
      gap: 10px;
    }

    .theme-select {
      width: 100%;
      padding: 8px 12px;
      background: var(--input-bg);
      border: 1px solid var(--border-dark);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.9rem;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 30px;
    }

    .theme-select:focus {
      outline: none;
      border-color: var(--accent-blood);
    }

    .data-actions {
      display: flex;
      gap: 8px;
    }

    .data-actions .btn {
      flex: 1;
      padding: 8px 10px;
      font-size: 0.8rem;
    }

    .last-sync {
      margin-top: 10px;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    /* Field customizations */
    .field-row {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .field-row .field {
      flex: 1;
      min-width: 150px;
      margin-bottom: 0;
    }

    /* Combat Stats */
    .combat-row {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
    }

    .combat-box {
      background: var(--input-bg);
      border: 1px solid var(--border-dark);
      padding: 8px 4px;
      text-align: center;
    }

    .combat-box.hp {
      border-color: var(--accent-blood);
    }

    .combat-box.arm {
      border-color: var(--accent-gold);
    }

    .combat-box.dmg {
      border-color: var(--accent-green);
    }

    .combat-box.coins {
      border-color: var(--accent-gold);
    }

    .combat-box .label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 4px;
      white-space: nowrap;
    }

    .combat-box .label span {
      color: var(--text-primary);
      font-weight: 600;
    }

    .combat-box input {
      padding: 4px 2px;
      background: transparent;
      border: none;
      border-bottom: 1px solid var(--border-dark);
      color: var(--text-heading);
      font-family: inherit;
      font-size: 1.2rem;
      font-weight: 700;
      text-align: center;
      width: 45px;
    }

    .combat-box input:focus {
      outline: none;
      border-bottom-color: var(--accent-blood);
    }

    /* Stats Table */
    .stats {
      border-collapse: collapse;
    }

    .stats thead th {
      cursor: pointer;
      transition: color 0.2s;
    }

    .stats thead th:hover {
      color: var(--accent-blood-light);
    }

    /* Party member line layout */
    .party-member .line {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin: 4px 0;
    }

    .party-member .name {
      font-weight: 600;
      color: var(--text-heading);
    }

    .party-member .class {
      color: var(--text-secondary);
    }

    .party-member .hp {
      color: var(--accent-blood-light);
    }

    .party-member .armor {
      color: var(--accent-gold);
    }

    .party-member .damage {
      color: var(--accent-green);
    }

    /* Moves */
    .moves-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .move-item {
      padding: 5px;
      background: var(--input-bg);
      border: 1px solid var(--border-dark);
      border-left: 3px solid var(--accent-blood);
      margin-bottom: 5px;
    }

    .move-header {
      display: flex;
      gap: 6px;
      align-items: center;
      margin-bottom: 6px;
    }

    .move-item input[type="text"] {
      flex: 1;
      padding: 4px 6px;
      background: transparent;
      border: none;
      border-bottom: 1px solid var(--border-dark);
      color: var(--text-heading);
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .move-item input[type="text"]:focus {
      outline: none;
      border-bottom-color: var(--accent-blood);
    }

    .move-remove {
      padding: 2px 8px;
      background: transparent;
      border: 1px solid var(--border-dark);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.8rem;
    }

    .move-remove:hover {
      border-color: var(--accent-blood);
      color: var(--accent-blood-light);
    }

    .move-item textarea {
      width: 100%;
      min-height: 100px;
      padding: 6px;
      background: transparent;
      border: 1px solid var(--border-dark);
      color: var(--text-secondary);
      font-family: inherit;
      font-size: 1rem;
      resize: none;
    }

    .move-item textarea:focus {
      outline: none;
      border-color: var(--accent-blood);
    }

    /* Dice panel */
    .dice-panel {
      position: fixed;
      z-index: 100;
      display: flex;
      align-items: flex-start;
      gap: 0;
    }

    .dice-panel-toggle {
      width: 48px;
      height: 48px;
      background: var(--accent-blood);
      border: none;
      color: var(--text-heading);
      font-size: 1.4rem;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .dice-panel-content {
      background: var(--bg-card);
      border: 1px solid var(--border-dark);
      padding: 15px;
      width: 220px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .dice-main {
      margin-bottom: 12px;
    }

    .dice-main .dice-btn {
      width: 100%;
      padding: 14px;
      font-size: 1.3rem;
      background: var(--input-bg);
      border: 2px solid var(--accent-blood);
    }

    .dice-main .dice-btn:hover {
      background: var(--accent-blood);
      color: var(--text-heading);
    }

    .dice-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    .dice-btn {
      padding: 10px 6px;
      background: var(--input-bg);
      border: 1px solid var(--border-dark);
      color: var(--text-heading);
      font-family: inherit;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.15s;
    }

    .dice-btn:hover {
      border-color: var(--accent-blood);
      background: var(--accent-blood);
      color: var(--text-heading);
    }

    .dice-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .dice-result .result-value {
      font-size: 2.2rem;
      font-weight: 700;
      color: #ffffff;
    }

    .dice-result .result-breakdown {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 3px;
    }

    .dice-result .result-offline {
      font-size: 0.75rem;
      color: var(--accent-gold);
      margin-top: 3px;
    }

    .cooldown-bar {
      height: 3px;
      background: var(--border-dark);
      margin-top: 8px;
    }

    .cooldown-bar .fill {
      height: 100%;
      background: var(--accent-blood);
      width: 0%;
      transition: width 0.1s linear;
    }

    .dice-log {
      margin-top: 8px;
      max-height: 80px;
      overflow-y: auto;
      font-size: 0.75rem;
      background: var(--bg-dark);
      border: 1px solid var(--border-dark);
    }

    .dice-log .log-entry {
      padding: 4px 8px;
      border-bottom: 1px solid var(--border-dark);
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .dice-log .log-entry:last-child {
      border-bottom: none;
    }

    .dice-log .log-time {
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .dice-log .log-result {
      color: var(--text-heading);
    }

    /* Toast container (animation) */
    .toast-container {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }

    .toast {
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s ease;
      pointer-events: auto;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* Layout Grid */
    .grid-main {
      display: grid;
      grid-template-columns: 5fr 5fr 2fr;
      gap: 15px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .dice-panel {
        right: 10px;
        top: auto;
        bottom: 20px;
        transform: none;
      }

      .dice-panel-toggle {
        display: flex;
      }

      .dice-panel-content {
        display: none;
        position: absolute;
        bottom: 54px;
        right: 0;
        width: 220px;
      }

      .dice-panel.open .dice-panel-content {
        display: block;
      }
    }

    @media (max-width: 600px) {
      .field-row {
        flex-direction: column;
      }

      .combat-row {
        grid-template-columns: repeat(3, 1fr);
      }

      .settings-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>

  <link rel="stylesheet" href="ui.css" />
  <script src="ui.js"></script>
</head>

<body>
  <header class="header">
    <div class="connection-indicator">
      <div class="connection-dot" id="connectionDot"></div>
      <span id="connectionText">Offline</span>
    </div>
    <h1 id="charName">–ë–µ–∑—ã–º—è–Ω–Ω—ã–π</h1>
    <div class="class-name" id="specializationName" style="text-transform: uppercase;">–ì–ï–†–û–ô</div>
  </header>

  <div class="container">
    <div class="grid-main">
      <div>
        <div class="panel">
          <button class="panel-toggle" data-panel-toggle-target="settingsContent">
            <span>‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
            <span class="arrow">‚óÄ</span>
          </button>
          <div class="panel-content" id="settingsContent">
            <div class="settings-grid">
              <div class="settings-field">
                <label>–°–µ—Ä–≤–µ—Ä</label>
                <input type="text" id="serverUrl" placeholder="http://localhost:3000">
              </div>
              <div class="settings-field">
                <label>–ö–æ–¥ –≥–µ—Ä–æ—è</label>
                <input type="text" id="heroCode" placeholder="ABC123">
              </div>
            </div>
            <div class="settings-grid" style="margin-top: 15px;">
              <div class="settings-field">
                <label>–¢–µ–º–∞</label>
                <select id="themeSelect" class="theme-select">
                  <option value="dark">üåô –ù–æ—á—å</option>
                  <option value="light">‚òÄÔ∏è –î–µ–Ω—å</option>
                </select>
              </div>
              <div class="settings-field">
                <label>–î–∞–Ω–Ω—ã–µ</label>
                <div class="data-actions">
                  <button class="btn secondary" id="exportBtn">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
                  <button class="btn secondary" id="importBtn">üì• –ò–º–ø–æ—Ä—Ç</button>
                  <input type="file" id="importFile" accept=".json" style="display: none;">
                </div>
              </div>
            </div>
            <div class="panel-actions">
              <button class="btn" id="loadBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞</button>
              <button class="btn secondary" id="saveNowBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–µ–π—á–∞—Å</button>
            </div>
            <div class="last-sync" id="lastSync"></div>
          </div>
        </div>

        <div class="card">
          <div class="field-row">
            <div class="field">
              <label data-label="name" class="form-label">–∏–º—è</label>
              <input type="text" id="name" class="form-input" data-field="name" maxlength="100" placeholder="–†–∞–≥–Ω–∞—Ä"
                disabled>
            </div>
            <div class="field">
              <label data-label="spec" class="form-label">–∫–ª–∞—Å—Å</label>
              <input type="text" id="specialization" class="form-input" data-field="specialization" maxlength="100"
                placeholder="–ë–µ—Ä—Å–µ—Ä–∫" style="text-transform: uppercase;" disabled>
            </div>
          </div>

          <table class="base-stats">
            <thead>
              <tr>
                <th>–£—Ä–æ–≤–µ–Ω—å</th>
                <th>–û–ø—ã—Ç(<span id="xpNext">8</span>)‚ú®</th>
                <th>–ó–¥–æ—Ä–æ–≤—å–µ(<span id="hpMax">16</span>)‚ù§Ô∏è</th>
                <th>–ë—Ä–æ–Ω—èüõ°Ô∏è</th>
                <th>–£—Ä–æ–Ω‚öîÔ∏è</th>
                <th>–ú–æ–Ω–µ—Ç—ã</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><input type="number" class="param" id="level" data-field="level" value="1" min="1" max="10"></td>
                <td><input type="number" class="param" id="xp" data-field="xp" value="0" min="0" max="20"></td>
                <td><input type="number" class="param" id="hpCurrent" data-field="hpCurrent" value="10" min="0"
                    max="60"></td>
                <td><input type="number" class="param" id="armor" data-field="armor" value="0" min="-5" max="10"></td>
                <td>
                  <input type="text" class="param" id="damage" data-field="damage" value="d6">
                </td>
                <td>
                  <input type="number" class="param" id="coins" data-field="coins" value="0">
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Stats + Abilities (Two Column Layout) -->
        <div class="card">

          <div class="stats-column">
            <h2>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h2>
            <table class="stats">
              <thead>
                <tr>
                  <th class="clickable" onclick="rollStat('str')" title="–ù–∞–∂–º–∏ –¥–ª—è –±—Ä–æ—Å–∫–∞ 2d6">–°–ò–õ</th>
                  <th class="clickable" onclick="rollStat('dex')" title="–ù–∞–∂–º–∏ –¥–ª—è –±—Ä–æ—Å–∫–∞ 2d6">–õ–û–í</th>
                  <th class="clickable" onclick="rollStat('con')" title="–ù–∞–∂–º–∏ –¥–ª—è –±—Ä–æ—Å–∫–∞ 2d6">–¢–ï–õ</th>
                  <th class="clickable" onclick="rollStat('int')" title="–ù–∞–∂–º–∏ –¥–ª—è –±—Ä–æ—Å–∫–∞ 2d6">–ò–ù–¢</th>
                  <th class="clickable" onclick="rollStat('wis')" title="–ù–∞–∂–º–∏ –¥–ª—è –±—Ä–æ—Å–∫–∞ 2d6">–ú–î–†</th>
                  <th class="clickable" onclick="rollStat('cha')" title="–ù–∞–∂–º–∏ –¥–ª—è –±—Ä–æ—Å–∫–∞ 2d6">–•–ê–†</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>
                    <input type="number" class="param" id="stat_str" data-field="stat_str" value="10" min="1" max="18">
                  </td>
                  <td>
                    <input type="number" class="param" id="stat_dex" data-field="stat_dex" value="10" min="1" max="18">
                  </td>
                  <td>
                    <input type="number" class="param" id="stat_con" data-field="stat_con" value="10" min="1" max="18">
                  </td>
                  <td>
                    <input type="number" class="param" id="stat_int" data-field="stat_int" value="10" min="1" max="18">
                  </td>
                  <td>
                    <input type="number" class="param" id="stat_wis" data-field="stat_wis" value="10" min="1" max="18">
                  </td>
                  <td>
                    <input type="number" class="param" id="stat_cha" data-field="stat_cha" value="10" min="1" max="18">
                  </td>
                </tr>
                <tr>
                  <td id="mod_str" class="text-center text-big">0</td>
                  <td id="mod_dex" class="text-center text-big">0</td>
                  <td id="mod_con" class="text-center text-big">0</td>
                  <td id="mod_int" class="text-center text-big">0</td>
                  <td id="mod_wis" class="text-center text-big">0</td>
                  <td id="mod_cha" class="text-center text-big">0</td>
                </tr>
                <tr>
                  <td class="text-center">
                    <label class="checkbox-custom" data-debuff-stat="str" data-debuff="-1">
                      <input type="checkbox" id="deb_str" data-field="deb_str">
                      <span class="checkbox-box"></span>
                      <span class="small">-1</span>
                    </label>
                  </td>
                  <td class="text-center">
                    <label class="checkbox-custom" data-debuff-stat="dex" data-debuff="-1">
                      <input type="checkbox" id="deb_dex" data-field="deb_dex">
                      <span class="checkbox-box"></span>
                      <span class="small">-1</span>
                    </label>
                  </td>
                  <td class="text-center">
                    <label class="checkbox-custom" data-debuff-stat="con" data-debuff="-1">
                      <input type="checkbox" id="deb_con" data-field="deb_con">
                      <span class="checkbox-box"></span>
                      <span class="small">-1</span>
                    </label>
                  </td>
                  <td class="text-center">
                    <label class="checkbox-custom" data-debuff-stat="int" data-debuff="-1">
                      <input type="checkbox" id="deb_int" data-field="deb_int">
                      <span class="checkbox-box"></span>
                      <span class="small">-1</span>
                    </label>
                  </td>
                  <td class="text-center">
                    <label class="checkbox-custom" data-debuff-stat="wis" data-debuff="-1">
                      <input type="checkbox" id="deb_wis" data-field="deb_wis">
                      <span class="checkbox-box"></span>
                      <span class="small">-1</span>
                    </label>
                  </td>
                  <td class="text-center">
                    <label class="checkbox-custom" data-debuff-stat="cha" data-debuff="-1">
                      <input type="checkbox" id="deb_cha" data-field="deb_cha">
                      <span class="checkbox-box"></span>
                      <span class="small">-1</span>
                    </label>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="box">
          <div class="tabs">
            <button class="tab-button active" onclick="switchTab(event, 'tab-weapons')">–û—Ä—É–∂–∏–µ</button>
            <button class="tab-button" onclick="switchTab(event, 'tab-equipment')">–°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ</button>
            <button class="tab-button" onclick="switchTab(event, 'tab-notes')">–ó–∞–º–µ—Ç–∫–∏</button>
          </div>

          <div id="tab-weapons" class="tab-content active">
            <div class="form-group">
              <textarea id="weapons" data-field="weapons" class="form-textarea"
                placeholder="–õ—É–∫ (near, far), –¢–æ–ø–æ—Ä (hand, thrown)..." rows="8"></textarea>
              <div class="char-count"><span data-field-count="weapons">0</span>/300</div>
            </div>
          </div>

          <div id="tab-equipment" class="tab-content">
            <div class="form-group">
              <textarea id="equipment" data-field="equipment" class="form-textarea"
                placeholder="–í–µ—Ä—ë–≤–∫–∞, —Ñ–∞–∫–µ–ª, –∑–µ–ª—å—è..." rows="8"></textarea>
              <div class="char-count"><span data-field-count="equipment">0</span>/300</div>
            </div>
          </div>

          <div id="tab-notes" class="tab-content">
            <div class="form-group">
              <textarea id="notes" data-field="notes" class="form-textarea" placeholder="–°–≤—è–∑–∏, –∑–∞–º–µ—Ç–∫–∏, –∫–≤–µ—Å—Ç—ã..."
                rows="8"></textarea>
              <div class="char-count"><span data-field-count="notes">0</span>/600</div>
            </div>
          </div>
        </div>
      </div>

      <div>
        <div class="box" style="overflow-y: scroll;">
          <div class="tabs">
            <button class="tab-button active" onclick="switchTab(event, 'tab-moves')">–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏</button>
            <button class="tab-button" onclick="switchTab(event, 'tab-party')">–ì—Ä—É–ø–ø–∞</button>
          </div>

          <div id="tab-moves" class="tab-content active">
            <div id="movesList"></div>
            <button class="btn btn-secondary" id="addMoveBtn">+ –î–æ–±–∞–≤–∏—Ç—å —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å</button>
          </div>

          <div id="tab-party" class="tab-content">
            <div class="party-list" id="partyList"></div>
            <div class="panel-actions">
              <button class="btn" id="partyRefresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
          </div>
        </div>
      </div>


      <div>
        <div class="dice-panel" id="dicePanel">
          <button class="dice-panel-toggle" id="dicePanelToggle">üé≤</button>
          <div class="dice-panel-content">
            <div class="dice-main">
              <button class="dice-btn" data-dice="2d6">2d6</button>
            </div>
            <div class="dice-buttons">
              <button class="dice-btn" data-dice="d4">d4</button>
              <button class="dice-btn" data-dice="d6">d6</button>
              <button class="dice-btn" data-dice="d8">d8</button>
              <button class="dice-btn" data-dice="d10">d10</button>
              <button class="dice-btn" data-dice="d12">d12</button>
              <button class="dice-btn" data-dice="d20">d20</button>
            </div>
            <div class="dice-result" id="diceResult">
              <div class="result-value">‚Äî</div>
              <div class="result-breakdown">–í—ã–±–µ—Ä–∏ –∫—É–±–∏–∫</div>
            </div>
            <div class="cooldown-bar">
              <div class="fill" id="cooldownFill"></div>
            </div>
            <div class="dice-log" id="diceLog"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sticky Dice Panel -->


  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <script>
    // ============================================================
    // CONFIG
    // ============================================================
    const Config = {
      STORAGE_KEY_SETTINGS: 'dw_settings',
      STORAGE_KEY_HERO: 'dw_hero',
      SCHEMA_VERSION: 1,
      COOLDOWN_MS: 1500,
      DEBOUNCE_MS: 1500,
      TIMEOUT_MS: 5000,
      RETRY_DELAY_MS: 1000,
      TOAST_DURATION_MS: 3000,
      MAX_MOVES: 5,
      STATS: ['str', 'dex', 'con', 'int', 'wis', 'cha']
    };

    // ============================================================
    // STATE
    // ============================================================
    const State = {
      settings: {
        serverUrl: '',
        heroCode: ''
      },
      hero: {
        specialization: 'hero',
        name: '',
        look: '',
        origin: '',
        level: 1,
        xp: 0,
        hpCurrent: 10,
        hpMax: 10,
        armor: 0,
        damage: 'd10',
        coins: 0,
        stats: { str: 10, dex: 10, con: 10, int: 10, wis: 10, cha: 10 },
        debilities: { str: false, dex: false, con: false, int: false, wis: false, cha: false },
        moves: [],
        weapons: '',
        equipment: '',
        bonds: '',
        notes: ''
      },
      version: 0,
      schemaVersion: Config.SCHEMA_VERSION,
      updatedAt: null,
      isOnline: false,
      isSyncing: false,
      lastRollTime: 0,
      cooldownInterval: null,
      syncTimeout: null
    };

    // ============================================================
    // TOAST MODULE
    // ============================================================
    const Toast = {
      show(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);

        requestAnimationFrame(() => toast.classList.add('show'));

        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 300);
        }, Config.TOAST_DURATION_MS);
      },

      info(message) { this.show(message, 'info'); },
      error(message) { this.show(message, 'error'); },
      success(message) { this.show(message, 'success'); }
    };

    // ============================================================
    // CONNECTION MODULE
    // ============================================================
    const Connection = {
      setStatus(isOnline, isSyncing = false) {
        State.isOnline = isOnline;
        State.isSyncing = isSyncing;

        const dot = document.getElementById('connectionDot');
        const text = document.getElementById('connectionText');

        dot.className = 'connection-dot';

        if (isSyncing) {
          dot.classList.add('syncing');
          text.textContent = '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...';
        } else if (isOnline) {
          text.textContent = 'Online';
        } else {
          dot.classList.add('offline');
          text.textContent = 'Offline';
        }
      }
    };

    // ============================================================
    // STORAGE MODULE
    // ============================================================
    const Storage = {
      loadSettings() {
        const saved = localStorage.getItem(Config.STORAGE_KEY_SETTINGS);
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        const server = params.get('server') || window.location.origin;

        if (saved && !code) {
          State.settings = { ...State.settings, ...JSON.parse(saved) };
        } else {
          State.settings = { serverUrl: server, heroCode: code }
        }
      },

      saveSettings() {
        localStorage.setItem(Config.STORAGE_KEY_SETTINGS, JSON.stringify(State.settings));
      },

      loadHero() {
        const saved = localStorage.getItem(Config.STORAGE_KEY_HERO);
        if (saved) {
          const data = JSON.parse(saved);
          // Migration
          if (!data.schemaVersion || data.schemaVersion < Config.SCHEMA_VERSION) {
            data.schemaVersion = Config.SCHEMA_VERSION;
          }
          State.hero = { ...State.hero, ...data.hero };
          State.version = data.version || 0;
          State.schemaVersion = data.schemaVersion;
          State.updatedAt = data.updatedAt;
        }
      },

      saveHero() {
        localStorage.setItem(Config.STORAGE_KEY_HERO, JSON.stringify({
          hero: State.hero,
          version: State.version,
          schemaVersion: State.schemaVersion,
          updatedAt: State.updatedAt
        }));
      }
    };

    // ============================================================
    // API MODULE
    // ============================================================
    const API = {
      async request(endpoint, body, retry = true) {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), Config.TIMEOUT_MS);

        try {
          const response = await fetch(`${State.settings.serverUrl}${endpoint}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
            signal: controller.signal
          });

          clearTimeout(timeout);
          return await response.json();
        } catch (err) {
          clearTimeout(timeout);

          if (retry && err.name !== 'AbortError') {
            await new Promise(r => setTimeout(r, Config.RETRY_DELAY_MS));
            return this.request(endpoint, body, false);
          }

          throw err;
        }
      },

      async get(endpoint, params = {}, retry = true) {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), Config.TIMEOUT_MS);

        try {
          const queryString = new URLSearchParams(params).toString();
          const url = `${State.settings.serverUrl}${endpoint}${queryString ? '?' + queryString : ''}`;

          const response = await fetch(url, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' },
            signal: controller.signal
          });

          clearTimeout(timeout);
          return await response.json();
        } catch (err) {
          clearTimeout(timeout);

          if (retry && err.name !== 'AbortError') {
            await new Promise(r => setTimeout(r, Config.RETRY_DELAY_MS));
            return this.get(endpoint, params, false);
          }

          throw err;
        }
      },

      async load() {
        if (!State.settings.serverUrl || !State.settings.heroCode) {
          Toast.error('–í–≤–µ–¥–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä –∏ –∫–æ–¥ –≥–µ—Ä–æ—è');
          return false;
        }

        Connection.setStatus(false, true);

        try {
          const result = await this.request('/api/heroes/load', {
            code: State.settings.heroCode
          });

          if (result.status === 'ok') {
            State.hero = { ...State.hero, ...result.hero };
            State.version = result.version;
            State.updatedAt = result.updatedAt;
            Storage.saveHero();
            Connection.setStatus(true);
            UI.update();
            Moves.render();
            UI.updateLastSync();
            Party.load();
            Toast.success('–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å —Å–µ—Ä–≤–µ—Ä–∞');
            return true;
          } else {
            Connection.setStatus(false);
            Toast.error(result.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
            return false;
          }
        } catch (err) {
          Connection.setStatus(false);
          Toast.error('–ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
          return false;
        }
      },

      async save() {
        if (!State.settings.serverUrl || !State.settings.heroCode) return;

        Connection.setStatus(State.isOnline, true);

        try {
          const result = await this.request('/api/heroes/save', {
            code: State.settings.heroCode,
            version: State.version,
            hero: State.hero
          });

          if (result.status === 'ok') {
            State.version = result.version;
            State.updatedAt = result.updatedAt;
            Storage.saveHero();
            Connection.setStatus(true);
            UI.updateLastSync();
          } else if (result.status === 'conflict') {
            // Server has newer data
            State.hero = { ...State.hero, ...result.hero };
            State.version = result.version;
            State.updatedAt = result.updatedAt;
            Storage.saveHero();
            Connection.setStatus(true);
            UI.update();
            Moves.render();
            UI.updateLastSync();
            Toast.info('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞');
          } else {
            Connection.setStatus(false);
            Toast.error(result.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
          }
        } catch (err) {
          Connection.setStatus(false);
          // Still save locally
          Storage.saveHero();
        }
      },

      saveDebounced() {
        Storage.saveHero();

        if (!State.settings.serverUrl || !State.settings.heroCode) return;

        if (State.syncTimeout) clearTimeout(State.syncTimeout);
        State.syncTimeout = setTimeout(() => this.save(), Config.DEBOUNCE_MS);
      },

      async roll(dice) {
        if (!State.settings.serverUrl || !State.settings.heroCode || !State.isOnline) {
          return null;
        }

        try {
          const result = await this.request('/api/roll', {
            code: State.settings.heroCode,
            dice: dice
          });

          if (result.status === 'ok') {
            return result;
          }
          return null;
        } catch (err) {
          return null;
        }
      }
    };

    // ============================================================
    // DICE MODULE
    // ============================================================
    const Dice = {
      rollLocal(dice) {
        const match = dice.match(/(\d*)d(\d+)/);
        const count = parseInt(match[1]) || 1;
        const sides = parseInt(match[2]);
        const rolls = [];

        for (let i = 0; i < count; i++) {
          rolls.push(Math.floor(Math.random() * sides) + 1);
        }

        return { rolls, total: rolls.reduce((a, b) => a + b, 0) };
      },

      formatResult(dice, rolls, total) {
        if (rolls.length === 1) {
          return `${dice}: ${total}`;
        }
        return `${dice}: ${rolls.join(' + ')} = ${total}`;
      },

      async execute(dice) {
        const now = Date.now();
        if (now - State.lastRollTime < Config.COOLDOWN_MS) return;

        State.lastRollTime = now;
        this.startCooldown();

        document.querySelectorAll('.dice-btn').forEach(btn => btn.disabled = true);

        const resultEl = document.getElementById('diceResult');
        resultEl.className = 'dice-result';
        resultEl.innerHTML = '<div class="result-value">...</div><div class="result-breakdown">' + dice + '</div>';

        let rolls = [];
        let total = 0;
        let isOffline = false;

        // Try server first
        const serverResult = await API.roll(dice);

        if (serverResult) {
          rolls = serverResult.rolls;
          total = serverResult.total;
        } else {
          // Local fallback
          const localResult = this.rollLocal(dice);
          rolls = localResult.rolls;
          total = localResult.total;
          isOffline = true;
        }

        // Display
        let className = '';
        if (dice === '2d6') {
          if (total >= 10) className = 'success';
          else if (total >= 7) className = 'partial';
          else className = 'fail';
        }

        const breakdown = this.formatResult(dice, rolls, total);

        resultEl.className = 'dice-result ' + className;
        resultEl.innerHTML = `
            <div class="result-value">${total}</div>
            <div class="result-breakdown">${breakdown}</div>
            ${isOffline ? '<div class="result-offline">(offline)</div>' : ''}
        `;

        this.addToLog(breakdown, isOffline);
      },

      startCooldown() {
        const fill = document.getElementById('cooldownFill');
        fill.style.width = '100%';

        let elapsed = 0;
        const step = 100;

        if (State.cooldownInterval) clearInterval(State.cooldownInterval);

        State.cooldownInterval = setInterval(() => {
          elapsed += step;
          fill.style.width = (100 - (elapsed / Config.COOLDOWN_MS * 100)) + '%';

          if (elapsed >= Config.COOLDOWN_MS) {
            clearInterval(State.cooldownInterval);
            fill.style.width = '0%';
            document.querySelectorAll('.dice-btn').forEach(btn => btn.disabled = false);
          }
        }, step);
      },

      addToLog(text, isOffline) {
        const log = document.getElementById('diceLog');
        const time = new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.innerHTML = `<span class="log-time">${time}</span><span class="log-result">${text}${isOffline ? ' (offline)' : ''}</span>`;

        log.insertBefore(entry, log.firstChild);
        log.scrollTop = 0;

        while (log.children.length > 5) {
          log.removeChild(log.lastChild);
        }
      }
    };

    // ============================================================
    // MOVES MODULE
    // ============================================================
    const Moves = {
      render() {
        const list = document.getElementById('movesList');
        list.innerHTML = '';

        (State.hero.moves || []).forEach((move, index) => {
          const item = document.createElement('div');
          item.className = 'move-item';
          item.innerHTML = `
                <div class="move-header">
                    <input type="text" value="${this.escape(move.name)}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏" data-move-index="${index}" data-move-field="name" maxlength="100">
                    <button class="move-remove" data-move-index="${index}">‚úï</button>
                </div>
                <textarea placeholder="–û–ø–∏—Å–∞–Ω–∏–µ..." data-move-index="${index}" data-move-field="desc" maxlength="300">${this.escape(move.desc)}</textarea>
            `;
          list.appendChild(item);
        });

        this.updateAddButton();
      },

      escape(text) {
        const div = document.createElement('div');
        div.textContent = text || '';
        return div.innerHTML;
      },

      updateAddButton() {
        document.getElementById('addMoveBtn').disabled = State.hero.moves.length >= Config.MAX_MOVES;
      },

      add() {
        if (State.hero.moves.length >= Config.MAX_MOVES) return;
        State.hero.moves.push({ name: '', desc: '' });
        API.saveDebounced();
        this.render();
      },

      remove(index) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å?')) return;
        State.hero.moves.splice(index, 1);
        API.saveDebounced();
        this.render();
      },

      update(index, field, value) {
        State.hero.moves[index][field] = value;
        API.saveDebounced();
      }
    };

    // ============================================================
    // UI MODULE
    // ============================================================
    const UI = {
      getModifier(value) {
        if (value <= 3) return -3;
        if (value <= 5) return -2;
        if (value <= 8) return -1;
        if (value <= 12) return 0;
        if (value <= 15) return 1;
        if (value <= 17) return 2;
        return 3;
      },

      formatModifier(mod) {
        if (mod == 0) return mod;

        return mod >= 0 ? '+' + mod : '' + mod;
      },

      update() {
        const h = State.hero;
        const s = State.settings;

        // Settings
        document.getElementById('serverUrl').value = s.serverUrl;
        document.getElementById('heroCode').value = s.heroCode;

        // Basic
        document.getElementById('name').value = h.name;
        document.getElementById('charName').textContent = h.name || '–ë–µ–∑—ã–º—è–Ω–Ω—ã–π';
        document.getElementById('specialization').value = h.specialization || '';
        document.getElementById('specializationName').textContent = h.specialization ? h.specialization.toUpperCase() : '–ì–ï–†–û–ô';

        // Optional fields - only update if they exist
        const lookEl = document.getElementById('look');
        if (lookEl) {
          lookEl.value = h.look;
          const lookCountEl = document.getElementById('lookCount');
          if (lookCountEl) lookCountEl.textContent = (h.look || '').length;
        }

        const originEl = document.getElementById('origin');
        if (originEl) {
          originEl.value = h.origin;
          const originCountEl = document.getElementById('originCount');
          if (originCountEl) originCountEl.textContent = (h.origin || '').length;
        }

        // Combat
        document.getElementById('level').value = h.level;
        document.getElementById('xp').value = h.xp;
        document.getElementById('xpNext').textContent = h.level + 7;
        document.getElementById('hpCurrent').value = h.hpCurrent;

        // Calculate max HP
        const conMod = this.getModifier(h.stats.con);
        document.getElementById('hpMax').textContent = h.hpMax;

        document.getElementById('armor').value = h.armor;
        document.getElementById('damage').value = h.damage;
        document.getElementById('coins').value = h.coins;

        // Stats + Debilities
        Config.STATS.forEach(stat => {
          document.getElementById('stat_' + stat).value = h.stats[stat];
          document.getElementById('deb_' + stat).checked = !!h.debilities[stat];

          const baseMod = this.getModifier(h.stats[stat]);
          const finalMod = h.debilities[stat] ? baseMod - 1 : baseMod;
          const modEl = document.getElementById('mod_' + stat);
          modEl.textContent = this.formatModifier(finalMod);
          modEl.className = h.debilities[stat] ? 'text-big modifier debilitated' : 'text-big modifier';
        });

        // Weapons & Equipment
        document.getElementById('weapons').value = h.weapons;
        document.querySelector('[data-field-count="weapons"]').textContent = (h.weapons || '').length;
        document.getElementById('equipment').value = h.equipment;
        document.querySelector('[data-field-count="equipment"]').textContent = (h.equipment || '').length;

        // Bonds & Notes
        document.getElementById('notes').value = h.notes;
        document.querySelector('[data-field-count="notes"]').textContent = (h.notes || '').length;
      },

      updateLastSync() {
        const el = document.getElementById('lastSync');
        if (State.updatedAt) {
          const date = new Date(State.updatedAt);
          el.textContent = `–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: ${date.toLocaleString('ru-RU')} (v${State.version})`;
        } else {
          el.textContent = '';
        }
      },

      handleFieldChange(e) {
        const field = e.target.dataset.field;
        if (!field) return;

        let value;
        if (e.target.type === 'checkbox') {
          value = e.target.checked;
        } else if (e.target.type === 'number') {
          value = parseInt(e.target.value) || 0;
        } else {
          value = e.target.value;
        }

        // Route to correct place
        if (field.startsWith('stat_')) {
          const stat = field.replace('stat_', '');
          State.hero.stats[stat] = value;

          // Update modifier display
          const baseMod = this.getModifier(value);
          const finalMod = State.hero.debilities[stat] ? baseMod - 1 : baseMod;
          const modEl = document.getElementById(stat + 'Mod');
          modEl.textContent = this.formatModifier(finalMod);
          modEl.className = State.hero.debilities[stat] ? 'modifier debilitated' : 'modifier';

          // Update max HP if CON changed
          if (stat === 'con') {
            document.getElementById('hpMax').textContent = State.hero.hpMax;
          }
        } else if (field.startsWith('deb_')) {
          const stat = field.replace('deb_', '');
          State.hero.debilities[stat] = value;

          const baseMod = this.getModifier(State.hero.stats[stat]);
          const finalMod = value ? baseMod - 1 : baseMod;
          const modEl = document.getElementById('mod_' + stat);
          modEl.textContent = this.formatModifier(finalMod);
        } else {
          State.hero[field] = value;

          // Update header name
          if (field === 'name') {
            document.getElementById('charName').textContent = value || '–ë–µ–∑—ã–º—è–Ω–Ω—ã–π';
          }

          // Update header class
          if (field === 'specialization') {
            document.getElementById('specializationName').textContent = value ? value.toUpperCase() : '–ì–ï–†–û–ô';
          }

          // Update XP next
          if (field === 'level') {
            document.getElementById('xpNext').textContent = value + 7;
          }
        }

        // Update char count
        const countEl = document.getElementById(field + 'Count');
        if (countEl && typeof value === 'string') {
          countEl.textContent = value.length;
        }

        API.saveDebounced();
      },

      handleSettingsChange(e) {
        const id = e.target.id;
        let value = e.target.value;

        State.settings[id] = value;
        Storage.saveSettings();
      }
    };

    // ============================================================
    // EVENTS
    // ============================================================
    const Events = {
      setup() {
        document.querySelectorAll("button.panel-toggle").forEach(btn => {
          btn.addEventListener('click', (e) => {
            let targetId = e.currentTarget.dataset.panelToggleTarget;
            e.currentTarget.classList.toggle('open');
            document.getElementById(targetId).classList.toggle('open');
          });
        });

        // Settings fields
        ['serverUrl', 'heroCode'].forEach(id => {
          document.getElementById(id).addEventListener('change', (e) => UI.handleSettingsChange(e));
        });

        // Load/Save buttons
        document.getElementById('loadBtn').addEventListener('click', () => API.load());
        document.getElementById('saveNowBtn').addEventListener('click', () => {
          API.save();
          Toast.info('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
        });

        // Character fields
        document.querySelectorAll('[data-field]').forEach(el => {
          el.addEventListener('input', (e) => UI.handleFieldChange(e));
          el.addEventListener('change', (e) => UI.handleFieldChange(e));
        });

        // Moves
        document.getElementById('movesList').addEventListener('input', (e) => {
          if (e.target.dataset.moveIndex !== undefined) {
            Moves.update(
              parseInt(e.target.dataset.moveIndex),
              e.target.dataset.moveField,
              e.target.value
            );
          }
        });

        document.getElementById('movesList').addEventListener('click', (e) => {
          if (e.target.classList.contains('move-remove')) {
            Moves.remove(parseInt(e.target.dataset.moveIndex));
          }
        });

        document.getElementById('addMoveBtn').addEventListener('click', () => Moves.add());

        // Dice
        document.querySelectorAll('.dice-btn').forEach(btn => {
          btn.addEventListener('click', () => Dice.execute(btn.dataset.dice));
        });

        // Dice panel toggle (mobile)
        document.getElementById('dicePanelToggle').addEventListener('click', () => {
          document.getElementById('dicePanel').classList.toggle('open');
        });

        // Number spinner buttons
        document.querySelectorAll('.btn-spinner').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            const targetId = btn.dataset.target;
            const action = btn.dataset.action;
            const input = document.getElementById(targetId);

            if (!input) return;

            let currentValue = parseInt(input.value) || 0;
            const min = input.min ? parseInt(input.min) : -Infinity;
            const max = input.max ? parseInt(input.max) : Infinity;

            if (action === 'increment') {
              currentValue = Math.min(currentValue + 1, max);
            } else if (action === 'decrement') {
              currentValue = Math.max(currentValue - 1, min);
            }

            input.value = currentValue;

            // Trigger change event to save
            input.dispatchEvent(new Event('input', { bubbles: true }));
            input.dispatchEvent(new Event('change', { bubbles: true }));
          });
        });

        // Theme select
        document.getElementById('themeSelect').addEventListener('change', (e) => {
          Theme.set(e.target.value);
        });

        // Export/Import
        document.getElementById('exportBtn').addEventListener('click', () => DataIO.export());
        document.getElementById('importBtn').addEventListener('click', () => {
          document.getElementById('importFile').click();
        });
        document.getElementById('importFile').addEventListener('change', (e) => {
          if (e.target.files.length > 0) {
            DataIO.import(e.target.files[0]);
            e.target.value = '';
          }
        });

        // Party refresh
        document.getElementById('partyRefresh').addEventListener('click', () => Party.load());
      }
    };

    // ============================================================
    // THEME MODULE
    // ============================================================
    const Theme = {
      STORAGE_KEY: 'dw_theme',

      init() {
        const saved = localStorage.getItem(this.STORAGE_KEY) || 'dark';
        this.apply(saved);
      },

      set(theme) {
        localStorage.setItem(this.STORAGE_KEY, theme);
        this.apply(theme);
      },

      apply(theme) {
        document.body.setAttribute('data-theme', theme);
        const select = document.getElementById('themeSelect');
        if (select) select.value = theme;
      }
    };

    // ============================================================
    // DATA IO MODULE
    // ============================================================
    const DataIO = {
      export() {
        const data = {
          version: State.version,
          exportedAt: new Date().toISOString(),
          hero: State.hero
        };

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${State.hero.name || 'hero'}_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        Toast.success('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
      },

      import(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);

            if (!data.hero) {
              Toast.error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
              return;
            }

            if (!confirm('–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞? –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã.')) {
              return;
            }

            State.hero = { ...State.hero, ...data.hero };
            Storage.saveHero();
            UI.update();
            Moves.render();
            Toast.success('–î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
          } catch (err) {
            Toast.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞');
          }
        };
        reader.readAsText(file);
      }
    };

    // ============================================================
    // PARTY MODULE
    // ============================================================
    const Party = {
      async load() {
        if (!State.settings.serverUrl || !State.settings.heroCode) return;

        const btn = document.getElementById('partyRefresh');
        btn.classList.add('loading');

        try {
          const result = await API.get('/api/party', {
            code: State.settings.heroCode
          });

          if (result.status === 'ok' && result.party && result.party.length > 0) {
            this.render(result.party);
          }
        } catch (err) {
          console.log(err);
        } finally {
          btn.classList.remove('loading');
        }
      },

      render(party) {
        const list = document.getElementById('partyList');

        list.innerHTML = party.map(member => `
          <div class="party-member">
            <div class="line">
              <span class="name">${this.escape(member.name) || '???'}</span>
              <span class="class">(${this.escape(member.specialization) || '‚Äî'})</span>
            </div>
            <div class="line">
              <span>${member.level || 0} ‚≠êÔ∏è</span>
              <span class="hp">${member.hpCurrent || 0}/${member.hpMax || 0} ‚ù§Ô∏è</span>
              <span class="armor">${member.armor || 0} üõ°Ô∏è</span>
              <span class="damage">${this.escape(member.damage) || '‚Äî'} ‚öîÔ∏è</span>
            </div>
          </div>
        `).join('');
      },

      escape(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    };

    // ============================================================
    // INIT
    // ============================================================
    async function init() {
      Theme.init();
      Storage.loadSettings();
      Storage.loadHero();
      UI.update();
      UI.updateLastSync();
      Moves.render();
      Events.setup();

      // Auto-load from server if configured
      if (State.settings.serverUrl && State.settings.heroCode) {
        await API.load();
      } else {
        Connection.setStatus(false);
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>

</body>

</html>